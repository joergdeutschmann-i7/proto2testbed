{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "config.schema.json",
    "title": "Proto-Testbed Config",
    "description": "Testbed config for a Proto-Testbed setup package",
    "type": "object",
    "properties": {
        "settings": {
            "type": "object",
            "properties": {
                "machines_internet_access": {
                    "type": "boolean"
                },
                "management_network": {
                    "type": "string"
                }
            },
            "additionalItems": false
        },
        "networks": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "name": {
                        "type": "string"
                    },
                    "physical_ports": {
                        "type": "array",
                        "items": {
                            "type": [
                                "string",
                                "null"
                            ]
                        }
                    }
                },
                "additionalItems": false,
                "required": [
                    "name",
                    "physical_ports"
                ]
            }
        },
        "integration": {
            "type": "object",
            "properties": {
                "mode": {
                    "type": "string",
                    "enum": [
                        "none",
                        "await",
                        "startstop"
                    ]
                },
                "environment": {
                    "type": [
                        "object",
                        "null"
                    ]
                },
                "invoke_after": {
                    "type": "string",
                    "enum": [
                        "startup",
                        "network",
                        "init"
                    ]
                },
                "wait_after_invoke": {
                    "type": "number"
                }
            },
            "additionalItems": false,
            "required": [
                "mode"
            ],
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "mode": {
                                "const": "await"
                            }
                        }
                    },
                    "then": {
                        "properties": {
                            "settings": {
                                "type": "object",
                                "properties": {
                                    "start_script": {
                                        "type": "string"
                                    },
                                    "wait_for_exit": {
                                        "type": "number"
                                    }
                                },
                                "required": [
                                    "start_script",
                                    "wait_for_exit"
                                ],
                                "additionalItems": false
                            }
                        }
                    }
                },
                {
                    "if": {
                        "properties": {
                            "mode": {
                                "const": "startstop"
                            }
                        }
                    },
                    "then": {
                        "properties": {
                            "settings": {
                                "type": "object",
                                "properties": {
                                    "start_script": {
                                        "type": "string"
                                    },
                                    "stop_script": {
                                        "type": "string"
                                    },
                                    "wait_for_exit": {
                                        "type": "number"
                                    }
                                },
                                "required": [
                                    "start_script",
                                    "stop_script"
                                ],
                                "additionalItems": false
                            }
                        }
                    }
                }
            ]
        },
        "machines": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "name": {
                        "type": "string"
                    },
                    "diskimage": {
                        "type": "string"
                    },
                    "setup_script": {
                        "type": [
                            "string",
                            "null"
                        ]
                    },
                    "environment": {
                        "type": [
                            "object",
                            "null"
                        ]
                    },
                    "cores": {
                        "type": "number"
                    },
                    "memory": {
                        "type": "number"
                    },
                    "networks": {
                        "oneOf": [
                            {
                                "type": "null"
                            },
                            {
                                "type": "array",
                                "items": {
                                    "type": "string"
                                }
                            }
                        ]
                    },
                    "collectors": {
                        "type": [
                            "array",
                            "null"
                        ],
                        "items": {
                            "type": "object",
                            "properties": {
                                "collector": {
                                    "type": "string",
                                    "enum": [
                                        "iperf3-client",
                                        "iperf3-server",
                                        "ping",
                                        "procmon"
                                    ]
                                },
                                "name": {
                                    "type": "string"
                                },
                                "delay": {
                                    "type": "number"
                                },
                                "runtime": {
                                    "type": "number"
                                },
                                "dont_store": {
                                    "type": "boolean"
                                },
                                "settings": {
                                    "type": "object"
                                }
                            },
                            "required": [
                                "collector",
                                "name",
                                "runtime",
                                "settings"
                            ],
                            "additionalItems": false,
                            "allOf": [
                                {
                                    "if": {
                                        "properties": {
                                            "collector": {
                                                "const": "iperf3-client"
                                            }
                                        }
                                    },
                                    "then": {
                                        "properties": {
                                            "settings": {
                                                "type": "object",
                                                "properties": {
                                                    "host": {
                                                        "type": "string"
                                                    },
                                                    "port": {
                                                        "type": "number"
                                                    },
                                                    "reverse": {
                                                        "type": "boolean"
                                                    },
                                                    "udp": {
                                                        "type": "boolean"
                                                    },
                                                    "streams": {
                                                        "type": "number"
                                                    },
                                                    "bandwitdth_kbps": {
                                                        "type": "number"
                                                    },
                                                    "tcp_no_delay": {
                                                        "type": "boolean"
                                                    },
                                                    "report_interval": {
                                                        "type": "number"
                                                    }
                                                },
                                                "required": [
                                                    "host"
                                                ],
                                                "additionalItems": false
                                            }
                                        }
                                    }
                                },
                                {
                                    "if": {
                                        "properties": {
                                            "collector": {
                                                "const": "iperf3-server"
                                            }
                                        }
                                    },
                                    "then": {
                                        "properties": {
                                            "settings": {
                                                "type": "object",
                                                "properties": {
                                                    "host": {
                                                        "type": "string"
                                                    },
                                                    "port": {
                                                        "type": "number"
                                                    },
                                                    "report_interval": {
                                                        "type": "number"
                                                    }
                                                },
                                                "required": [],
                                                "additionalItems": false
                                            }
                                        }
                                    }
                                },
                                {
                                    "if": {
                                        "properties": {
                                            "collector": {
                                                "const": "ping"
                                            }
                                        }
                                    },
                                    "then": {
                                        "properties": {
                                            "settings": {
                                                "type": "object",
                                                "properties": {
                                                    "target": {
                                                        "type": "string"
                                                    },
                                                    "source": {
                                                        "type": "string"
                                                    },
                                                    "interval": {
                                                        "type": "number"
                                                    },
                                                    "packetsize": {
                                                        "type": "number"
                                                    },
                                                    "ttl": {
                                                        "type": "number"
                                                    },
                                                    "timeout": {
                                                        "type": "number"
                                                    }
                                                },
                                                "required": [
                                                    "target"
                                                ],
                                                "additionalItems": false
                                            }
                                        }
                                    }
                                },
                                {
                                    "if": {
                                        "properties": {
                                            "collector": {
                                                "const": "procmon"
                                            }
                                        }
                                    },
                                    "then": {
                                        "properties": {
                                            "settings": {
                                                "type": "object",
                                                "properties": {
                                                    "interval": {
                                                        "type": "number"
                                                    },
                                                    "interfaces": {
                                                        "type": "array",
                                                        "items": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "processes": {
                                                        "type": "array",
                                                        "items": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "system": {
                                                        "type": "boolean"
                                                    }
                                                },
                                                "required": [],
                                                "additionalItems": false
                                            }
                                        }
                                    }
                                }
                            ]
                        }
                    }
                },
                "additionalItems": false,
                "required": [
                    "name",
                    "diskimage",
                    "setup_script",
                    "environment",
                    "networks",
                    "collectors"
                ]
            }
        }
    },
    "required": [
        "settings",
        "networks",
        "machines"
    ],
    "additionalItems": false
}
