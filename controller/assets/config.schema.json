{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "config.schema.json",
    "title": "Proto-Testbed Config",
    "description": "Testbed config for a Proto-Testbed setup package",
    "type": "object",
    "properties": {
        "settings": {
            "type": "object",
            "properties": {
                "management_network": {
                    "type": "string"
                },
                "diskimage_basepath": {
                    "type": "string"
                },
                "startup_init_timeout": {
                    "type": "number"
                },
                "experiment_timeout": {
                    "type": "number"
                }
            },
            "additionalItems": false
        },
        "networks": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "name": {
                        "type": "string"
                    },
                    "host_ports": {
                        "type": "array",
                        "items": {
                            "type": [
                                "string",
                                "null"
                            ]
                        }
                    }
                },
                "additionalItems": false,
                "required": [
                    "name",
                    "host_ports"
                ]
            }
        },
        "integrations": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "name": {
                        "type": "string"
                    },
                    "mode": {
                        "type": "string",
                        "enum": [
                            "await",
                            "startstop",
                            "ns3-emulation"
                        ]
                    },
                    "environment": {
                        "type": [
                            "object",
                            "null"
                        ]
                    },
                    "invoke_after": {
                        "type": "string",
                        "enum": [
                            "startup",
                            "network",
                            "init"
                        ]
                    },
                    "wait_after_invoke": {
                        "type": "number"
                    }
                },
                "additionalItems": false,
                "required": [
                    "name",
                    "mode",
                    "settings"
                ],
                "allOf": [
                    {
                        "if": {
                            "properties": {
                                "mode": {
                                    "const": "await"
                                }
                            }
                        },
                        "then": {
                            "properties": {
                                "settings": {
                                    "type": "object",
                                    "properties": {
                                        "start_script": {
                                            "type": "string"
                                        },
                                        "wait_for_exit": {
                                            "type": "number"
                                        },
                                        "start_delay": {
                                            "type": "number"
                                        }
                                    },
                                    "required": [
                                        "start_script",
                                        "wait_for_exit"
                                    ],
                                    "additionalItems": false
                                }
                            }
                        }
                    },
                    {
                        "if": {
                            "properties": {
                                "mode": {
                                    "const": "startstop"
                                }
                            }
                        },
                        "then": {
                            "properties": {
                                "settings": {
                                    "type": "object",
                                    "properties": {
                                        "start_script": {
                                            "type": "string"
                                        },
                                        "stop_script": {
                                            "type": "string"
                                        },
                                        "wait_for_exit": {
                                            "type": "number"
                                        },
                                        "start_delay": {
                                            "type": "number"
                                        }
                                    },
                                    "required": [
                                        "start_script",
                                        "stop_script"
                                    ],
                                    "additionalItems": false
                                }
                            }
                        }
                    },
                    {
                        "if": {
                            "properties": {
                                "mode": {
                                    "const": "ns3-emulation"
                                }
                            }
                        },
                        "then": {
                            "properties": {
                                "settings": {
                                    "type": "object",
                                    "properties": {
                                        "basepath": {
                                            "type": "string"
                                        },
                                        "program": {
                                            "type": "string"
                                        },
                                        "interfaces": {
                                            "type": "array",
                                            "items": {
                                                "type": "string"
                                            }
                                        },
                                        "wait": {
                                            "type": "boolean"
                                        },
                                        "fail_on_exist": {
                                            "type": "boolean"
                                        },
                                        "args": {
                                            "type": [
                                                "object",
                                                "null"
                                            ]
                                        }
                                    },
                                    "required": [
                                        "basepath",
                                        "program",
                                        "interfaces"
                                    ],
                                    "additionalItems": false
                                }
                            }
                        }
                    }
                ]
            }
        },
        "instances": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "name": {
                        "type": "string"
                    },
                    "diskimage": {
                        "type": "string"
                    },
                    "setup_script": {
                        "type": [
                            "string",
                            "null"
                        ]
                    },
                    "environment": {
                        "type": [
                            "object",
                            "null"
                        ]
                    },
                    "cores": {
                        "type": "number"
                    },
                    "memory": {
                        "type": "number"
                    },
                    "netmodel": {
                        "type": "string",
                        "enum": [
                            "virtio",
                            "e1000",
                            "rtl8139"
                        ]
                    },
                    "networks": {
                        "oneOf": [
                            {
                                "type": "null"
                            },
                            {
                                "type": "array",
                                "items": {
                                    "type": "string"
                                }
                            }
                        ]
                    },
                    "applications": {
                        "type": [
                            "array",
                            "null"
                        ],
                        "items": {
                            "type": "object",
                            "properties": {
                                "application": {
                                    "type": "string",
                                    "enum": [
                                        "iperf3-client",
                                        "iperf3-server",
                                        "ping",
                                        "procmon",
                                        "run-program"
                                    ]
                                },
                                "name": {
                                    "type": "string"
                                },
                                "delay": {
                                    "type": "number"
                                },
                                "runtime": {
                                    "type": "number"
                                },
                                "dont_store": {
                                    "type": "boolean"
                                },
                                "settings": {
                                    "type": "object"
                                }
                            },
                            "required": [
                                "application",
                                "name",
                                "runtime",
                                "settings"
                            ],
                            "additionalItems": false,
                            "allOf": [
                                {
                                    "if": {
                                        "properties": {
                                            "application": {
                                                "const": "iperf3-client"
                                            }
                                        }
                                    },
                                    "then": {
                                        "properties": {
                                            "settings": {
                                                "type": "object",
                                                "properties": {
                                                    "host": {
                                                        "type": "string"
                                                    },
                                                    "port": {
                                                        "type": "number"
                                                    },
                                                    "reverse": {
                                                        "type": "boolean"
                                                    },
                                                    "udp": {
                                                        "type": "boolean"
                                                    },
                                                    "streams": {
                                                        "type": "number"
                                                    },
                                                    "bandwitdth_kbps": {
                                                        "type": "number"
                                                    },
                                                    "tcp_no_delay": {
                                                        "type": "boolean"
                                                    },
                                                    "report_interval": {
                                                        "type": "number"
                                                    }
                                                },
                                                "required": [
                                                    "host"
                                                ],
                                                "additionalItems": false
                                            }
                                        }
                                    }
                                },
                                {
                                    "if": {
                                        "properties": {
                                            "application": {
                                                "const": "iperf3-server"
                                            }
                                        }
                                    },
                                    "then": {
                                        "properties": {
                                            "settings": {
                                                "type": "object",
                                                "properties": {
                                                    "host": {
                                                        "type": "string"
                                                    },
                                                    "port": {
                                                        "type": "number"
                                                    },
                                                    "report_interval": {
                                                        "type": "number"
                                                    }
                                                },
                                                "required": [],
                                                "additionalItems": false
                                            }
                                        }
                                    }
                                },
                                {
                                    "if": {
                                        "properties": {
                                            "application": {
                                                "const": "ping"
                                            }
                                        }
                                    },
                                    "then": {
                                        "properties": {
                                            "settings": {
                                                "type": "object",
                                                "properties": {
                                                    "target": {
                                                        "type": "string"
                                                    },
                                                    "source": {
                                                        "type": "string"
                                                    },
                                                    "interval": {
                                                        "type": "number"
                                                    },
                                                    "packetsize": {
                                                        "type": "number"
                                                    },
                                                    "ttl": {
                                                        "type": "number"
                                                    },
                                                    "timeout": {
                                                        "type": "number"
                                                    }
                                                },
                                                "required": [
                                                    "target"
                                                ],
                                                "additionalItems": false
                                            }
                                        }
                                    }
                                },
                                {
                                    "if": {
                                        "properties": {
                                            "application": {
                                                "const": "procmon"
                                            }
                                        }
                                    },
                                    "then": {
                                        "properties": {
                                            "settings": {
                                                "type": "object",
                                                "properties": {
                                                    "interval": {
                                                        "type": "number"
                                                    },
                                                    "interfaces": {
                                                        "type": "array",
                                                        "items": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "processes": {
                                                        "type": "array",
                                                        "items": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "system": {
                                                        "type": "boolean"
                                                    }
                                                },
                                                "required": [],
                                                "additionalItems": false
                                            }
                                        }
                                    }
                                },
                                {
                                    "if": {
                                        "properties": {
                                            "application": {
                                                "const": "run-program"
                                            }
                                        }
                                    },
                                    "then": {
                                        "properties": {
                                            "settings": {
                                                "type": "object",
                                                "properties": {
                                                    "command": {
                                                        "type": "string"
                                                    },
                                                    "ignore_timeout": {
                                                        "type": "boolean"
                                                    },
                                                    "environment": {
                                                        "type": [
                                                            "object",
                                                            "null"
                                                        ]
                                                    }
                                                },
                                                "required": [
                                                    "command"
                                                ],
                                                "additionalItems": false
                                            }
                                        }
                                    }
                                }
                            ]
                        }
                    }
                },
                "additionalItems": false,
                "required": [
                    "name",
                    "diskimage",
                    "setup_script",
                    "environment",
                    "networks",
                    "applications"
                ]
            }
        }
    },
    "required": [
        "settings",
        "networks",
        "integrations",
        "instances"
    ],
    "additionalItems": false
}
